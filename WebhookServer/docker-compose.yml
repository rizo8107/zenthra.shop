version: '3.8'

services:
  webhook-payment-server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: webhook-payment-server
    restart: unless-stopped
    ports:
      - "${PORT:-3001}:3001"
    environment:
      # Server
      PORT: ${PORT:-3001}
      NODE_ENV: ${NODE_ENV:-production}
      CORS_ORIGIN: ${CORS_ORIGIN:-*}
      
      # Razorpay
      RAZORPAY_KEY_ID: ${RAZORPAY_KEY_ID}
      RAZORPAY_KEY_SECRET: ${RAZORPAY_KEY_SECRET}
      RAZORPAY_WEBHOOK_SECRET: ${RAZORPAY_WEBHOOK_SECRET}
      
      # PocketBase
      POCKETBASE_URL: ${POCKETBASE_URL}
      POCKETBASE_ADMIN_EMAIL: ${POCKETBASE_ADMIN_EMAIL}
      POCKETBASE_ADMIN_PASSWORD: ${POCKETBASE_ADMIN_PASSWORD}
      
      # Webhooks
      WEBHOOKS_ADMIN_API_KEY: ${WEBHOOKS_ADMIN_API_KEY}
      WEBHOOKS_COLLECTION: ${WEBHOOKS_COLLECTION:-webhooks}
      WEBHOOKS_FAILURES_COLLECTION: ${WEBHOOKS_FAILURES_COLLECTION:-webhook_failures}
      
      # Automation
      AUTOMATION_FLOWS_COLLECTION: ${AUTOMATION_FLOWS_COLLECTION:-automation_flows}
      AUTOMATION_TRIGGERS_COLLECTION: ${AUTOMATION_TRIGGERS_COLLECTION:-automation_triggers}
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3001/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    networks:
      - webhook-network

networks:
  webhook-network:
    driver: bridge
