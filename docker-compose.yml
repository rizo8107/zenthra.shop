services:
  frontend:
    build:
      context: ./Frontend
      dockerfile: Dockerfile
      args:
        VITE_POCKETBASE_URL: ${VITE_POCKETBASE_URL}
        VITE_RAZORPAY_KEY_ID: ${VITE_RAZORPAY_KEY_ID}
        VITE_EVOLUTION_API_KEY: ${VITE_EVOLUTION_API_KEY}
        VITE_EVOLUTION_API_URL: ${VITE_EVOLUTION_API_URL}
        VITE_EVOLUTION_INSTANCE_NAME: ${VITE_EVOLUTION_INSTANCE_NAME}
        VITE_CRM_ORDER_ENDPOINT: ${VITE_CRM_ORDER_ENDPOINT}
        VITE_SITE_TITLE: ${VITE_SITE_TITLE}
        VITE_SITE_LOGO: ${VITE_SITE_LOGO}
        VITE_GOOGLE_MAPS_API_KEY: ${VITE_GOOGLE_MAPS_API_KEY}
        VITE_ZENTHRA_FRONTEND_URL: ${VITE_ZENTHRA_FRONTEND_URL}
        VITE_ZENTHRA_AUTH_PATH: ${VITE_ZENTHRA_AUTH_PATH}
        WEBHOOK_SERVER_URL: ${WEBHOOK_SERVER_URL}
        VITE_WEBHOOKS_API_BASE: ${VITE_WEBHOOKS_API_BASE}
        VITE_PUBLIC_POSTHOG_KEY: ${VITE_PUBLIC_POSTHOG_KEY}
        VITE_PUBLIC_POSTHOG_HOST: ${VITE_PUBLIC_POSTHOG_HOST}
    expose:
      - "80"
    ports:
      - "3000:80"   # Local: http://localhost:3000
    restart: unless-stopped
    labels:
      - traefik.enable=true
      - traefik.docker.network=dokploy-network
      - traefik.http.routers.front-web.rule=Host(`karigaistore.in`)
      - traefik.http.routers.front-web.entrypoints=web
      - traefik.http.routers.front-websecure.rule=Host(`karigaistore.in`)
      - traefik.http.routers.front-websecure.entrypoints=websecure
      - traefik.http.routers.front-websecure.tls.certresolver=letsencrypt
      - traefik.http.services.front.loadbalancer.server.port=80
    networks:
      - dokploy-network

  cms:
    build:
      context: ./Backend
      dockerfile: Dockerfile
      args:
        VITE_POCKETBASE_URL: ${VITE_POCKETBASE_URL}
        VITE_RAZORPAY_KEY_ID: ${VITE_RAZORPAY_KEY_ID}
        VITE_CMS_BASE: "/"  # ensure backend builds for root when running on its own port
        VITE_VAPID_PUBLIC_KEY: ${VITE_VAPID_PUBLIC_KEY}
        VITE_EVOLUTION_API_KEY: ${VITE_EVOLUTION_API_KEY}
        VITE_EVOLUTION_API_URL: ${VITE_EVOLUTION_API_URL}
        VITE_EVOLUTION_INSTANCE_NAME: ${VITE_EVOLUTION_INSTANCE_NAME}
        VITE_ZENTHRA_FRONTEND_URL: ${VITE_ZENTHRA_FRONTEND_URL}
        VITE_ZENTHRA_AUTH_PATH: ${VITE_ZENTHRA_AUTH_PATH}
        WEBHOOK_SERVER_URL: ${WEBHOOK_SERVER_URL}
        VITE_WEBHOOKS_API_BASE: ${VITE_WEBHOOKS_API_BASE}
    environment:
      PORT: "8080"
      SERVER_PORT: "3001"
      NODE_ENV: production
      WEBHOOK_SERVER_URL: ${WEBHOOK_SERVER_URL}
      VITE_POCKETBASE_URL: ${VITE_POCKETBASE_URL}
      VITE_POCKETBASE_ADMIN_EMAIL: ${VITE_POCKETBASE_ADMIN_EMAIL}
      VITE_POCKETBASE_ADMIN_PASSWORD: ${VITE_POCKETBASE_ADMIN_PASSWORD}
      WEBHOOKS_ADMIN_API_KEY: ${WEBHOOKS_ADMIN_API_KEY}
      WEBHOOKS_COLLECTION: ${WEBHOOKS_COLLECTION}
      WEBHOOKS_FAILURES_COLLECTION: ${WEBHOOKS_FAILURES_COLLECTION}
    expose:
      - "8080"
      - "3001"
    ports:
      - "4000:8080" # Local CMS UI: http://localhost:4000
      - "3001:3001" # Local CMS API: http://localhost:3001
    restart: unless-stopped
    labels:
      - traefik.enable=true
      - traefik.docker.network=dokploy-network
      - "traefik.http.routers.cms-web.rule=Host(`admin.karigaistore.in`)"
      - traefik.http.routers.cms-web.entrypoints=web
      - "traefik.http.routers.cms-websecure.rule=Host(`admin.karigaistore.in`)"
      - traefik.http.routers.cms-websecure.entrypoints=websecure
      - traefik.http.routers.cms-websecure.tls.certresolver=letsencrypt
      - traefik.http.services.cms.loadbalancer.server.port=8080
      - "traefik.http.routers.cms-api.rule=Host(`admin.karigaistore.in`) && PathPrefix(`/api`)"
      - traefik.http.routers.cms-api.entrypoints=web
      - traefik.http.routers.cms-api.priority=100
      - "traefik.http.routers.cms-api-secure.rule=Host(`admin.karigaistore.in`) && PathPrefix(`/api`)"
      - traefik.http.routers.cms-api-secure.entrypoints=websecure
      - traefik.http.routers.cms-api-secure.priority=100
      - traefik.http.routers.cms-api-secure.tls.certresolver=letsencrypt
      - traefik.http.routers.cms-api.service=cms-api
      - traefik.http.routers.cms-api-secure.service=cms-api
      - traefik.http.services.cms-api.loadbalancer.server.port=3001
    networks:
      - dokploy-network

networks:
  dokploy-network:
    external: true
# Usage:
# 1) Ensure .env at repo root contains all variables referenced above.
# 2) docker compose up --build -d
#    Frontend: http://localhost:3000
#    CMS:      http://localhost:4000 (API: http://localhost:3001)
