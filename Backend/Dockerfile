# Use Node.js LTS as the base image
FROM node:20-alpine

# Set working directory
WORKDIR /app

# Define build arguments for environment variables
ARG VITE_POCKETBASE_URL
ARG POCKETBASE_ADMIN_EMAIL
ARG POCKETBASE_ADMIN_PASSWORD
ARG VITE_RAZORPAY_KEY_ID
ARG RAZORPAY_KEY_SECRET
ARG VITE_SITE_TITLE
ARG VITE_SITE_LOGO
ARG VITE_CMS_BASE
ARG VITE_VAPID_PUBLIC_KEY
ARG VITE_EVOLUTION_API_KEY
ARG VITE_EVOLUTION_API_URL
ARG VITE_EVOLUTION_INSTANCE_NAME
ARG EMAIL_HOST
ARG EMAIL_PORT
ARG EMAIL_USER
ARG EMAIL_PASSWORD
ARG EMAIL_FROM
ARG SMTP_HOST
ARG SMTP_PORT
ARG SMTP_SECURE
ARG SMTP_USER
ARG SMTP_PASSWORD
ARG VITE_GEMINI_API_KEY
ARG VITE_WHATSAPP_API_URL
ARG VITE_ZENTHRA_FRONTEND_URL
ARG WEBHOOK_SERVER_URL
ARG VITE_WEBHOOKS_API_BASE
ARG VITE_POCKETBASE_ADMIN_EMAIL
ARG VITE_POCKETBASE_ADMIN_PASSWORD
ARG WEBHOOKS_ADMIN_API_KEY
ARG WEBHOOKS_COLLECTION
ARG WEBHOOKS_FAILURES_COLLECTION

# Set environment variables (only VITE_* are consumed by Vite at build)
ENV VITE_POCKETBASE_URL=$VITE_POCKETBASE_URL
ENV POCKETBASE_ADMIN_EMAIL=$POCKETBASE_ADMIN_EMAIL
ENV POCKETBASE_ADMIN_PASSWORD=$POCKETBASE_ADMIN_PASSWORD
ENV VITE_RAZORPAY_KEY_ID=$VITE_RAZORPAY_KEY_ID
ENV RAZORPAY_KEY_SECRET=$RAZORPAY_KEY_SECRET
ENV VITE_SITE_TITLE=$VITE_SITE_TITLE
ENV VITE_SITE_LOGO=$VITE_SITE_LOGO
ENV VITE_CMS_BASE=$VITE_CMS_BASE
ENV VITE_VAPID_PUBLIC_KEY=$VITE_VAPID_PUBLIC_KEY
ENV VITE_EVOLUTION_API_KEY=$VITE_EVOLUTION_API_KEY
ENV VITE_EVOLUTION_API_URL=$VITE_EVOLUTION_API_URL
ENV VITE_EVOLUTION_INSTANCE_NAME=$VITE_EVOLUTION_INSTANCE_NAME
ENV EMAIL_HOST=$EMAIL_HOST
ENV EMAIL_PORT=$EMAIL_PORT
ENV EMAIL_USER=$EMAIL_USER
ENV EMAIL_PASSWORD=$EMAIL_PASSWORD
ENV EMAIL_FROM=$EMAIL_FROM
ENV SMTP_HOST=$SMTP_HOST
ENV SMTP_PORT=$SMTP_PORT
ENV SMTP_SECURE=$SMTP_SECURE
ENV SMTP_USER=$SMTP_USER
ENV SMTP_PASSWORD=$SMTP_PASSWORD
ENV VITE_GEMINI_API_KEY=$VITE_GEMINI_API_KEY
ENV VITE_WHATSAPP_API_URL=$VITE_WHATSAPP_API_URL
ENV VITE_ZENTHRA_FRONTEND_URL=$VITE_ZENTHRA_FRONTEND_URL
ENV WEBHOOK_SERVER_URL=$WEBHOOK_SERVER_URL
ENV VITE_WEBHOOKS_API_BASE=$VITE_WEBHOOKS_API_BASE
ENV VITE_POCKETBASE_ADMIN_EMAIL=$VITE_POCKETBASE_ADMIN_EMAIL
ENV VITE_POCKETBASE_ADMIN_PASSWORD=$VITE_POCKETBASE_ADMIN_PASSWORD
ENV WEBHOOKS_ADMIN_API_KEY=$WEBHOOKS_ADMIN_API_KEY
ENV WEBHOOKS_COLLECTION=$WEBHOOKS_COLLECTION
ENV WEBHOOKS_FAILURES_COLLECTION=$WEBHOOKS_FAILURES_COLLECTION

# Copy package.json and package-lock.json
COPY package*.json ./

# Install dependencies including dev dependencies needed for build
RUN npm install

# Copy the rest of the application code
COPY . .

# Build frontend + server bundle
RUN npm run build:all

# Remove dev dependencies for smaller runtime image
RUN npm prune --production

# Copy entrypoint script that starts static host + API server
COPY docker-entrypoint.sh ./docker-entrypoint.sh
RUN chmod +x docker-entrypoint.sh

# Runtime environment
ENV NODE_ENV=production
ENV PORT=8080
ENV SERVER_PORT=3001

# Expose static + API ports (static served on 8080, API on 3001)
EXPOSE 8080 3001

# Run both static site and API (trap signals for graceful shutdown)
ENTRYPOINT ["./docker-entrypoint.sh"]
